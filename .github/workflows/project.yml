name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed, ready_for_review]
  workflow_dispatch:
    inputs:
      sync_all:
        description: 'Sync all open issues/PRs to project'
        required: false
        default: false
        type: boolean

jobs:
  project_automation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Add new items to project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/users/NightMira/projects/3
          github-token: ${{ secrets.PRIVATE_REPO_TOKEN }}
        if: |
          github.event.action == 'opened' || 
          github.event.action == 'reopened' || 
          github.event.action == 'ready_for_review'

      - name: Update status for closed items
        if: github.event.action == 'closed'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "🔄 Processing closed item..." >> $GITHUB_STEP_SUMMARY
          
          # Получаем данные проекта
          gh api graphql -f query='
            query($user: String!, $number: Int!) {
              user(login: $user) {
                projectV2(number: $number) {
                  id
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f user="NightMira" -F number=3 > project_data.json
          
          PROJECT_ID=$(jq -r '.data.user.projectV2.id' project_data.json)
          STATUS_FIELD_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .id' project_data.json)
          DONE_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .options[] | select(.name=="Done") | .id' project_data.json)
          
          if [ -n "$STATUS_FIELD_ID" ] && [ -n "$DONE_OPTION_ID" ]; then
            # Находим item в проекте и обновляем статус
            if [ "${{ github.event_name }}" = "issues" ]; then
              CONTENT_ID="${{ github.event.issue.node_id }}"
            else
              CONTENT_ID="${{ github.event.pull_request.node_id }}"
            fi
            
            ITEM_ID=$(gh api graphql -f query='
              query($project: ID!, $content: ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }' -f project="$PROJECT_ID" -f content="$CONTENT_ID" \
              --jq '.data.node.items.nodes[] | select(.content.id == $content) | .id')
            
            if [ -n "$ITEM_ID" ]; then
              gh api graphql -f query='
                mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $project
                    itemId: $item
                    fieldId: $field
                    value: {
                      singleSelectOptionId: $value
                    }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$STATUS_FIELD_ID" -f value="$DONE_OPTION_ID" --silent
              
              echo "✅ Status updated to Done" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Manual bulk sync
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_all == 'true'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "### 🔍 Manual Bulk Sync" >> $GITHUB_STEP_SUMMARY
          echo "📦 Adding all open issues and PRs to project..." >> $GITHUB_STEP_SUMMARY
          
          # Issues
          gh issue list --state open --json number,url --jq '.[]' | while read -r item; do
            number=$(echo "$item" | jq -r '.number')
            url=$(echo "$item" | jq -r '.url')
            
            if gh project item-add 3 --owner NightMira --url "$url" 2>/dev/null; then
              echo "✅ Issue #$number" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ Issue #$number" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # PRs
          gh pr list --state open --json number,url --jq '.[]' | while read -r item; do
            number=$(echo "$item" | jq -r '.number')
            url=$(echo "$item" | jq -r '.url')
            
            if gh project item-add 3 --owner NightMira --url "$url" 2>/dev/null; then
              echo "✅ PR #$number" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ PR #$number" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "🎯 Manual sync completed!" >> $GITHUB_STEP_SUMMARY