name: Auto Label Issues and PRs

on:
  workflow_dispatch:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: üè∑Ô∏è Auto-label issues and PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          script: |
            try {
              const issueData = context.payload.issue;
              const prData = context.payload.pull_request;
              
              if (!issueData && !prData) {
                console.log('‚ùå No issue or PR data found');
                return;
              }

              const target = issueData || prData;
              const { title, body, number, labels = [] } = target;
              const type = issueData ? 'issue' : 'pull_request';

              if (!title) {
                console.log(`‚ö†Ô∏è No title found for ${type} #${number}`);
                return;
              }

              console.log(`üìã Processing ${type}: "${title}" (#${number})`);

              const content = `${title} ${body || ''}`.toLowerCase();
              const currentLabels = new Set(labels.map(label => label.name));

              // ==================== üéØ TASK TYPES ====================
              if (content.includes('bug') || content.includes('–æ—à–∏–±–∫–∞') || content.includes('error') || content.includes('fix') || content.includes('–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ') || content.includes('–±–∞–≥') || content.includes('–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç')) {
                currentLabels.add('type-bug');
              }

              if (content.includes('feature') || content.includes('—Ñ—É–Ω–∫—Ü–∏—è') || content.includes('—É–ª—É—á—à–µ–Ω–∏–µ') || content.includes('–Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å') || content.includes('–¥–æ–±–∞–≤–∏—Ç—å') || content.includes('–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ')) {
                currentLabels.add('type-feature');
              }

              if (content.includes('refactor') || content.includes('—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥') || content.includes('–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è') || content.includes('–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞') || content.includes('cleanup')) {
                currentLabels.add('type-refactor');
              }

              if (content.includes('build') || content.includes('—Å–±–æ—Ä–∫–∞') || content.includes('ci/cd') || content.includes('compile') || content.includes('–∫–æ–º–ø–∏–ª—è—Ü–∏—è') || content.includes('pipeline')) {
                currentLabels.add('type-build');
              }

              if (content.includes('doc') || content.includes('documentation') || content.includes('–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è') || content.includes('readme') || content.includes('–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è') || content.includes('wiki')) {
                currentLabels.add('type-docs');
              }

              if (content.includes('test') || content.includes('—Ç–µ—Å—Ç') || content.includes('testing') || content.includes('—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') || content.includes('–ø—Ä–æ–≤–µ—Ä–∫–∞')) {
                currentLabels.add('type-test');
              }

              // ==================== ‚ö° PRIORITIES ====================
              if (content.includes('critical') || content.includes('–∫—Ä–∏—Ç–∏—á') || content.includes('–±–ª–æ–∫–∏—Ä') || content.includes('—Å—Ä–æ—á–Ω–æ') || content.includes('–∞–≤–∞—Ä–∏–π') || content.includes('urgent')) {
                currentLabels.add('priority-critical');
              } else if (content.includes('high') || content.includes('–≤—ã—Å–æ–∫') || content.includes('–≤–∞–∂–Ω') || content.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç') || content.includes('important')) {
                currentLabels.add('priority-high');
              } else if (content.includes('medium') || content.includes('—Å—Ä–µ–¥–Ω') || content.includes('–æ–±—ã—á–Ω') || content.includes('normal')) {
                currentLabels.add('priority-medium');
              } else if (content.includes('low') || content.includes('–Ω–∏–∑–∫') || content.includes('—É–ª—É—á—à–µ–Ω') || content.includes('–Ω–µ–≤–∞–∂–Ω') || content.includes('minor')) {
                currentLabels.add('priority-low');
              }

              // ==================== üß© COMPONENTS ====================
              if (content.includes('compiler') || content.includes('–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä') || content.includes('amxxpc') || content.includes('amxx') || content.includes('—Å–±–æ—Ä–∫')) {
                currentLabels.add('component-compiler');
              }

              if (content.includes('ci/cd') || content.includes('pipeline') || content.includes('github action') || content.includes('workflow') || content.includes('–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è') || content.includes('action')) {
                currentLabels.add('component-ci-cd');
              }

              if (content.includes('plugin') || content.includes('–ø–ª–∞–≥–∏–Ω') || content.includes('.sma') || content.includes('.amxx') || content.includes('–º–æ–¥—É–ª—å') || content.includes('script')) {
                currentLabels.add('component-plugins');
              }

              if (content.includes('doc') || content.includes('–¥–æ–∫—É–º–µ–Ω—Ç') || content.includes('readme') || content.includes('wiki') || content.includes('–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è') || content.includes('guide')) {
                currentLabels.add('component-docs');
              }

              if (content.includes('version') || content.includes('–≤–µ—Ä—Å–∏—è') || content.includes('semver') || content.includes('release') || content.includes('–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ')) {
                currentLabels.add('component-versioning');
              }

              // ==================== üìä VERSIONING ====================
              if (content.includes('major') || content.includes('–º–∞–∂–æ—Ä') || content.includes('x.0.0') || content.includes('breaking')) {
                currentLabels.add('version-major');
              }

              if (content.includes('minor') || content.includes('–º–∏–Ω–æ—Ä') || content.includes('0.y.0') || content.includes('feature')) {
                currentLabels.add('version-minor');
              }

              if (content.includes('patch') || content.includes('–ø–∞—Ç—á') || content.includes('0.0.z') || content.includes('hotfix') || content.includes('–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ') || content.includes('bugfix')) {
                currentLabels.add('version-patch');
              }

              // ==================== üöÄ RELEASE STAGES ====================
              if (content.includes('dev') || content.includes('—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞') || content.includes('development') || content.includes('wip')) {
                currentLabels.add('stage-dev');
              }

              if (content.includes('alpha') || content.includes('–∞–ª—å—Ñ–∞') || content.includes('test')) {
                currentLabels.add('stage-alpha');
              }

              if (content.includes('beta') || content.includes('–±–µ—Ç–∞') || content.includes('testing')) {
                currentLabels.add('stage-beta');
              }

              if (content.includes('rc') || content.includes('release candidate') || content.includes('—Ä–µ–ª–∏–∑-–∫–∞–Ω–¥–∏–¥–∞—Ç') || content.includes('pre-release')) {
                currentLabels.add('stage-rc');
              }

              if (content.includes('release') || content.includes('—Ä–µ–ª–∏–∑') || content.includes('production') || content.includes('–ø—Ä–æ–¥–∞–∫—à–µ–Ω') || content.includes('final')) {
                currentLabels.add('stage-release');
              }

              if (content.includes('hotfix') || content.includes('—Ö–æ—Ç—Ñ–∏–∫—Å') || content.includes('—Å—Ä–æ—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ') || content.includes('emergency')) {
                currentLabels.add('stage-hotfix');
              }

              // ==================== üîÑ PR-SPECIFIC LOGIC ====================
              if (prData) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è PR
                currentLabels.add('component-plugins');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                const { additions, deletions } = prData;
                const totalChanges = additions + deletions;
                
                if (totalChanges > 500) {
                  currentLabels.add('priority-critical');
                } else if (totalChanges > 200) {
                  currentLabels.add('priority-high');
                } else if (totalChanges > 50) {
                  currentLabels.add('priority-medium');
                } else if (totalChanges > 0) {
                  currentLabels.add('priority-low');
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–¥–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Ç–∫–∏
                const baseRef = prData.base.ref.toLowerCase();
                if (baseRef === 'main') {
                  currentLabels.add('stage-release');
                } else if (baseRef === 'dev') {
                  currentLabels.add('stage-dev');
                } else if (baseRef.includes('alpha')) {
                  currentLabels.add('stage-alpha');
                } else if (baseRef.includes('beta')) {
                  currentLabels.add('stage-beta');
                } else if (baseRef.includes('rc')) {
                  currentLabels.add('stage-rc');
                } else if (baseRef.includes('hotfix')) {
                  currentLabels.add('stage-hotfix');
                }

                // –î–æ–±–∞–≤–ª—è–µ–º workflow –º–µ—Ç–∫–∏ –¥–ª—è PR
                currentLabels.add('workflow-needs-review');
              }

              // ==================== üéØ ISSUE-SPECIFIC LOGIC ====================
              if (issueData) {
                // –î–ª—è issue –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É workflow
                currentLabels.add('workflow-auto');
              }

              // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤
              const labelsToAdd = Array.from(currentLabels);

              if (labelsToAdd.length > 0) {
                console.log(`üè∑Ô∏è Setting labels: ${labelsToAdd.join(', ')}`);
                
                await github.rest.issues.setLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  labels: labelsToAdd
                });
                
                // Create summary
                const summary = `
                ## üè∑Ô∏è Auto-Label Summary
                
                ### üìã ${type.toUpperCase()} Information
                - **Number:** #${number}
                - **Title:** ${title}
                - **Type:** ${type}
                
                ### üìä Labels Applied
                ${labelsToAdd.map(label => `- \`${label}\``).join('\n')}
                
                ### üîç Content Analysis
                Content processed for keyword matching.
                
                *Auto-labeled at ${new Date().toLocaleString()}*
                `;
                
                // Write to summary
                const fs = require('fs');
                fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
                
                console.log('‚úÖ Labels updated successfully');
              } else {
                console.log('‚ÑπÔ∏è No labels to add');
                
                const summary = `
                ## üè∑Ô∏è Auto-Label Summary
                
                ### üìã ${type.toUpperCase()} Information
                - **Number:** #${number}
                - **Title:** ${title}
                - **Type:** ${type}
                
                ### ‚ÑπÔ∏è No Labels Applied
                No matching labels found based on content analysis.
                
                *Processed at ${new Date().toLocaleString()}*
                `;
                
                const fs = require('fs');
                fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
              }

            } catch (error) {
              console.error('üí• Error in auto-label workflow:', error.message);
              
              const summary = `
              ## üè∑Ô∏è Auto-Label Summary
              
              ### ‚ùå Error Occurred
              ${error.message}
              
              *Failed at ${new Date().toLocaleString()}*
              `;
              
              const fs = require('fs');
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
            }