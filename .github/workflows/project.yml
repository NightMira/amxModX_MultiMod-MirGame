name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed, ready_for_review]
  workflow_dispatch:
    inputs:
      sync_all:
        description: 'Sync all open issues/PRs to project'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  project_automation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Add new items to project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/users/NightMira/projects/3
          github-token: ${{ secrets.GITHUB_TOKEN }}
        if: |
          github.event.action == 'opened' || 
          github.event.action == 'reopened' || 
          github.event.action == 'ready_for_review'

      - name: Update status for closed items
        if: github.event.action == 'closed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”„ Processing closed item..." >> $GITHUB_STEP_SUMMARY
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          gh api graphql -f query='
            query($user: String!, $number: Int!) {
              user(login: $user) {
                projectV2(number: $number) {
                  id
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                        dataType
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f user="${{ github.repository_owner }}" -F number=3 > project_data.json
          
          PROJECT_ID=$(jq -r '.data.user.projectV2.id' project_data.json)
          STATUS_FIELD_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status" and .dataType=="SINGLE_SELECT") | .id' project_data.json)
          DONE_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status" and .dataType=="SINGLE_SELECT") | .options[] | select(.name=="Done") | .id' project_data.json)
          
          if [ -n "$STATUS_FIELD_ID" ] && [ -n "$DONE_OPTION_ID" ]; then
            if [ "${{ github.event_name }}" = "issues" ]; then
              CONTENT_ID="${{ github.event.issue.node_id }}"
            else
              CONTENT_ID="${{ github.event.pull_request.node_id }}"
            fi
            
            # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ item Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ
            ITEM_ID=$(gh api graphql -f query='
              query($project: ID!, $content: ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }' -f project="$PROJECT_ID" -f content="$CONTENT_ID" \
              --jq ".data.node.items.nodes[] | select(.content.id == \"$CONTENT_ID\") | .id")
            
            if [ -n "$ITEM_ID" ]; then
              gh api graphql -f query='
                mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $project
                    itemId: $item
                    fieldId: $field
                    value: {
                      singleSelectOptionId: $value
                    }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$STATUS_FIELD_ID" -f value="$DONE_OPTION_ID" --silent
              
              if [ $? -eq 0 ]; then
                echo "âœ… Status updated to Done for item $ITEM_ID" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Failed to update status" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âš ï¸ Item not found in project" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Status field or Done option not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Manual bulk sync
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_all == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### ðŸ” Manual Bulk Sync" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Adding all open issues and PRs to project..." >> $GITHUB_STEP_SUMMARY
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾Ð¼Ñƒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑŽ
          echo "ðŸ” Checking repository access..." >> $GITHUB_STEP_SUMMARY
          gh api "repos/${{ github.repository }}" --jq '.name' >> $GITHUB_STEP_SUMMARY 2>&1 || echo "âŒ Cannot access repository" >> $GITHUB_STEP_SUMMARY
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ PROJECT_ID
          gh api graphql -f query='
            query($user: String!, $number: Int!) {
              user(login: $user) {
                projectV2(number: $number) {
                  id
                  title
                }
              }
            }' -f user="${{ github.repository_owner }}" -F number=3 > project_data.json
          
          PROJECT_ID=$(jq -r '.data.user.projectV2.id' project_data.json)
          PROJECT_TITLE=$(jq -r '.data.user.projectV2.title' project_data.json)
          
          echo "ðŸŽ¯ Working with project: $PROJECT_TITLE" >> $GITHUB_STEP_SUMMARY
          
          # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚
          add_to_project() {
            local content_id="$1"
            local item_type="$2"
            local number="$3"
            local title="$4"
            
            result=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId,
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }' -f projectId="$PROJECT_ID" -f contentId="$content_id" --silent 2>&1)
            
            if [ $? -eq 0 ]; then
              echo "âœ… $item_type #$number: $title" >> $GITHUB_STEP_SUMMARY
              return 0
            else
              if echo "$result" | grep -q "already exists"; then
                echo "â„¹ï¸  $item_type #$number already in project: $title" >> $GITHUB_STEP_SUMMARY
                return 0
              elif echo "$result" | grep -q "Resource not accessible by integration"; then
                echo "ðŸ” $item_type #$number: Token lacks permissions" >> $GITHUB_STEP_SUMMARY
                return 1
              else
                echo "âš ï¸ Failed to add $item_type #$number: $title" >> $GITHUB_STEP_SUMMARY
                echo "   Error: $result" >> $GITHUB_STEP_SUMMARY
                return 1
              fi
            fi
          }
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ issues Ð¸Ð· Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
          echo "ðŸ” Processing issues..." >> $GITHUB_STEP_SUMMARY
          gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                issues(first: 100, states: OPEN, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes {
                    number
                    id
                    title
                    state
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" > issues.json
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to fetch issues from private repository" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          added_count=0
          while IFS= read -r issue; do
            if [ -n "$issue" ]; then
              number=$(echo "$issue" | jq -r '.number')
              id=$(echo "$issue" | jq -r '.id')
              title=$(echo "$issue" | jq -r '.title' | head -c 80)
              state=$(echo "$issue" | jq -r '.state')
              
              if [ "$state" = "OPEN" ]; then
                if add_to_project "$id" "Issue" "$number" "$title"; then
                  added_count=$((added_count + 1))
                fi
              fi
            fi
          done < <(jq -c '.data.repository.issues.nodes[]' issues.json)
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ PRs Ð¸Ð· Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
          echo "ðŸ” Processing PRs..." >> $GITHUB_STEP_SUMMARY
          gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                pullRequests(first: 100, states: OPEN, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes {
                    number
                    id
                    title
                    state
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" > prs.json
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to fetch PRs from private repository" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          while IFS= read -r pr; do
            if [ -n "$pr" ]; then
              number=$(echo "$pr" | jq -r '.number')
              id=$(echo "$pr" | jq -r '.id')
              title=$(echo "$pr" | jq -r '.title' | head -c 80)
              state=$(echo "$pr" | jq -r '.state')
              
              if [ "$state" = "OPEN" ]; then
                if add_to_project "$id" "PR" "$number" "$title"; then
                  added_count=$((added_count + 1))
                fi
              fi
            fi
          done < <(jq -c '.data.repository.pullRequests.nodes[]' prs.json)
          
          echo "ðŸŽ¯ Manual sync completed! Added $added_count items to project." >> $GITHUB_STEP_SUMMARY
