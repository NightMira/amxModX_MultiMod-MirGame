name: Add to Project

on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  add_to_project:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: ðŸ”‘ Authenticate GitHub CLI
        run: |
          echo "${{ secrets.PRIVATE_REPO_TOKEN }}" | gh auth login --with-token

      - name: ðŸ“Š Get project data
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          USER: NightMira
          PROJECT_NUMBER: 3
        run: |
          echo "## ðŸ—‚ï¸ Project Automation" >> $GITHUB_STEP_SUMMARY
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          gh api graphql -f query='
            query($user: String!, $number: Int!) {
              user(login: $user) {
                projectV2(number: $number) {
                  id
                  title
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f user=$USER -f number=$PROJECT_NUMBER > project_data.json

          # ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ID Ð² environment variables
          echo 'PROJECT_ID='$(jq '.data.user.projectV2.id' project_data.json) >> $GITHUB_ENV
          echo 'PROJECT_TITLE='$(jq -r '.data.user.projectV2.title' project_data.json) >> $GITHUB_ENV
          
          # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð»Ðµ Status
          STATUS_FIELD_ID=$(jq '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .id' project_data.json)
          if [ "$STATUS_FIELD_ID" != "null" ] && [ -n "$STATUS_FIELD_ID" ]; then
            echo 'STATUS_FIELD_ID='$STATUS_FIELD_ID >> $GITHUB_ENV
            echo 'TODO_OPTION_ID='$(jq '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .options[] | select(.name=="Todo") | .id' project_data.json) >> $GITHUB_ENV
          fi
          
          # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð»Ðµ Date posted
          DATE_FIELD_ID=$(jq '.data.user.projectV2.fields.nodes[] | select(.name== "Date posted") | .id' project_data.json)
          if [ "$DATE_FIELD_ID" != "null" ] && [ -n "$DATE_FIELD_ID" ]; then
            echo 'DATE_FIELD_ID='$DATE_FIELD_ID >> $GITHUB_ENV
          fi

          echo "ðŸ“Š Project: $PROJECT_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ Project ID: $PROJECT_ID" >> $GITHUB_STEP_SUMMARY

      - name: âž• Add item to project
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ID ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¸Ð¿Ð° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
          if [ "${{ github.event_name }}" = "issues" ]; then
            CONTENT_ID="${{ github.event.issue.node_id }}"
            ITEM_TYPE="issue"
            ITEM_NUMBER=${{ github.event.issue.number }}
          else
            CONTENT_ID="${{ github.event.pull_request.node_id }}"
            ITEM_TYPE="pull request"
            ITEM_NUMBER=${{ github.event.pull_request.number }}
          fi

          echo "ðŸŽ¯ Adding $ITEM_TYPE #$ITEM_NUMBER to project..." >> $GITHUB_STEP_SUMMARY

          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚
          item_id=$(gh api graphql -f query='
            mutation($project:ID!, $content:ID!) {
              addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                item {
                  id
                }
              }
            }' -f project=$PROJECT_ID -f content=$CONTENT_ID --jq '.data.addProjectV2ItemById.item.id')

          echo 'ITEM_ID='$item_id >> $GITHUB_ENV
          echo "âœ… Added to project! Item ID: $item_id" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“… Get current date
        if: env.ITEM_ID != ''
        run: echo "DATE=$(date +"%Y-%m-%d")" >> $GITHUB_ENV

      - name: âš™ï¸ Set field values
        if: env.ITEM_ID != '' && (env.STATUS_FIELD_ID != '' || env.DATE_FIELD_ID != '')
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "ðŸ”§ Setting field values..." >> $GITHUB_STEP_SUMMARY
          
          # Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹
          QUERY_BASE='
            mutation ($project: ID!, $item: ID!'
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‡Ð°ÑÑ‚Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹
          VARIABLES="-f project=$PROJECT_ID -f item=$ITEM_ID"
          QUERY_FIELDS=""
          QUERY_BODY=""
          
          if [ -n "$STATUS_FIELD_ID" ] && [ -n "$TODO_OPTION_ID" ]; then
            QUERY_BASE+=', $status_field: ID!, $status_value: String!'
            VARIABLES+=" -f status_field=$STATUS_FIELD_ID -f status_value=$TODO_OPTION_ID"
            QUERY_FIELDS+='
              set_status: updateProjectV2ItemFieldValue(input: {
                projectId: $project
                itemId: $item
                fieldId: $status_field
                value: {
                  singleSelectOptionId: $status_value
                }
              }) {
                projectV2Item {
                  id
                }
              }'
          fi
          
          if [ -n "$DATE_FIELD_ID" ]; then
            QUERY_BASE+=', $date_field: ID!, $date_value: Date!'
            VARIABLES+=" -f date_field=$DATE_FIELD_ID -f date_value=$DATE"
            QUERY_FIELDS+='
              set_date: updateProjectV2ItemFieldValue(input: {
                projectId: $project
                itemId: $item
                fieldId: $date_field
                value: {
                  date: $date_value
                }
              }) {
                projectV2Item {
                  id
                }
              }'
          fi
          
          QUERY_BASE+=') {'
          FULL_QUERY="$QUERY_BASE $QUERY_FIELDS }"
          
          if [ -n "$QUERY_FIELDS" ]; then
            gh api graphql -f query="$FULL_QUERY" $VARIABLES --silent
            echo "âœ… Field values set successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No fields to set (Status or Date posted fields not found)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“‹ Create summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Workflow Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "- **Issue:** #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Title:** ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Pull Request:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Project:** $PROJECT_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Project URL:** https://github.com/users/NightMira/projects/3" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully added to project" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          gh auth logout || true