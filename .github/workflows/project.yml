name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  project-automation:
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Checkout code (with private token)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: üìã Add new items to project
        if: github.event_name == 'issues' && github.event.action == 'opened' || github.event_name == 'pull_request' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "üéØ Adding ${{ github.event_name }} to project..."
          
          if [ "${{ github.event_name }}" = "issues" ]; then
            ITEM_URL="https://github.com/NightMira/amxModX_MultiMod-MirGame/issues/${{ github.event.issue.number }}"
            echo "üìù Issue URL: $ITEM_URL"
          else
            ITEM_URL="https://github.com/NightMira/amxModX_MultiMod-MirGame/pull/${{ github.event.pull_request.number }}"
            echo "üìù PR URL: $ITEM_URL"
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ–µ–∫—Ç (–Ω–æ–º–µ—Ä 3 –¥–ª—è users/NightMira/projects/3)
          echo "üèóÔ∏è Adding to project #3..."
          gh project item-add 3 \
            --owner NightMira \
            --url "$ITEM_URL"
          
          echo "‚úÖ Added to project successfully!"

      - name: üè∑Ô∏è Update project status
        if: github.event.action == 'closed' || github.event.action == 'reopened' || github.event.action == 'ready_for_review'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "üîÑ Updating project status for ${{ github.event_name }} #${{ github.event.issue.number || github.event.pull_request.number }}"
          
          # –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–æ–º–µ—Ä 3)
          PROJECT_ID=$(gh api graphql -f query='
            query {
              user(login: "NightMira") {
                projectV2(number: 3) {
                  id
                }
              }
            }
          ' | jq -r '.data.user.projectV2.id')
          
          echo "üìä Project ID: $PROJECT_ID"
          
          if [ "${{ github.event_name }}" = "issues" ]; then
            CONTENT_ID="${{ github.event.issue.node_id }}"
            echo "üìã Issue Node ID: $CONTENT_ID"
          else
            CONTENT_ID="${{ github.event.pull_request.node_id }}"
            echo "üìã PR Node ID: $CONTENT_ID"
          fi
          
          if [ -n "$PROJECT_ID" ] && [ -n "$CONTENT_ID" ]; then
            # –ù–∞—Ö–æ–¥–∏–º ID —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ
            ITEM_ID=$(gh api graphql -f query='
              query {
                node(id: "'$PROJECT_ID'") {
                  ... on ProjectV2 {
                    items(first: 50) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                            number
                          }
                          ... on PullRequest {
                            id
                            number
                          }
                        }
                      }
                    }
                  }
                }
              }
            ' | jq -r '.data.node.items.nodes[] | select(.content.id == "'$CONTENT_ID'") | .id')
            
            echo "üéØ Item ID: $ITEM_ID"
            
            if [ -n "$ITEM_ID" ]; then
              # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              if [ "${{ github.event.action }}" = "closed" ]; then
                STATUS="Done"
              elif [ "${{ github.event.action }}" = "reopened" ] || [ "${{ github.event.action }}" = "ready_for_review" ]; then
                STATUS="In Progress"
              else
                STATUS="Todo"
              fi
              
              echo "üìä Setting status to: $STATUS"
              
              # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ø—Ä–æ–µ–∫—Ç–µ
              gh api graphql -f query='
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: "'$PROJECT_ID'",
                    itemId: "'$ITEM_ID'",
                    fieldId: "Status",
                    value: {
                      singleSelectOptionId: "'$STATUS'"
                    }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              '
              echo "‚úÖ Status updated successfully"
            else
              echo "‚ö†Ô∏è Item not found in project"
            fi
          else
            echo "‚ö†Ô∏è Missing Project ID or Content ID"
          fi