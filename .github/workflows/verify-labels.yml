name: Verify Labels Exist

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['.github/labels.yml']

jobs:
  verify-labels:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: ðŸ·ï¸ Verify all labels from labels.yml exist
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "ðŸ” Verifying labels from labels.yml..."
          
          # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸ Ð¸Ð· labels.yml
          labels=$(grep -E "name:" .github/labels.yml | awk -F '"' '{print $2}')
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¼ÐµÑ‚Ð¾Ðº
          existing_labels=$(gh label list --limit 100 | awk '{print $1}')
          
          for label in $labels; do
            if echo "$existing_labels" | grep -q "^$label$"; then
              echo "âœ… Label exists: $label"
            else
              echo "âŒ Label missing: $label"
              echo "   Creating missing label..."
              
              # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ†Ð²ÐµÑ‚ Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð· labels.yml
              color=$(grep -A2 "name: \"$label\"" .github/labels.yml | grep "color:" | awk -F '"' '{print $2}')
              description=$(grep -A2 "name: \"$label\"" .github/labels.yml | grep "description:" | awk -F '"' '{print $2}')
              
              # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
              color=${color:-"000000"}
              description=${description:-"Auto-created label"}
              
              gh label create "$label" --color "$color" --description "$description" --force
            fi
          done
          
          echo "âœ… All labels verified!"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ summary
          echo "## ðŸ·ï¸ Label Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Verification Status" >> $GITHUB_STEP_SUMMARY
          echo "All labels from `.github/labels.yml` have been verified." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Labels Processed" >> $GITHUB_STEP_SUMMARY
          echo "Total labels in manifest: $(echo "$labels" | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â° Timestamp" >> $GITHUB_STEP_SUMMARY
          echo "$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY