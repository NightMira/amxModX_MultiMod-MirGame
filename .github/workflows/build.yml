name: AMXX Build System

on:
  push:
    branches: [main, dev, pre-release/alpha/*, pre-release/beta/*, pre-release/rc/*, hotfix/*]
  pull_request:
    branches: [main, dev]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libc6-i386 lib32stdc++6 lib32z1 lib32gcc-s1 wget tar jq

      - name: ğŸ”§ Download AMXX Compiler
        run: |
          wget -q https://github.com/NightMira/amxmodx_1-9/releases/download/v1.9/amxmodx19.tar
          tar -xf amxmodx19.tar
          chmod +x amxxpc
          ./amxxpc --help || true

      - name: ğŸ·ï¸ Determine version based on branch
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "ğŸ“‹ Current branch: $BRANCH_NAME"
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
          CURRENT_VERSION=$(python3 update_version.py get-version)
          CURRENT_SUFFIX=$(python3 update_version.py get-suffix)
          
          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "VERSION_STRATEGY=release" >> $GITHUB_ENV
            echo "ARTIFACT_SUFFIX=stable" >> $GITHUB_ENV
            echo "VERSION_CMD=release" >> $GITHUB_ENV
            
          elif [[ "$BRANCH_NAME" == "dev" ]]; then
            echo "VERSION_STRATEGY=snapshot" >> $GITHUB_ENV
            echo "ARTIFACT_SUFFIX=dev" >> $GITHUB_ENV
            if [[ "$CURRENT_SUFFIX" != *"SNAPSHOT"* ]]; then
              echo "VERSION_CMD=snapshot" >> $GITHUB_ENV
            else
              echo "VERSION_CMD=" >> $GITHUB_ENV
            fi
            
          elif [[ "$BRANCH_NAME" =~ ^pre-release/alpha/ ]]; then
            ALPHA_NUM="${BRANCH_NAME##*/}"
            echo "VERSION_STRATEGY=pre-release" >> $GITHUB_ENV
            echo "ARTIFACT_SUFFIX=alpha-$ALPHA_NUM" >> $GITHUB_ENV
            echo "VERSION_CMD=alpha $ALPHA_NUM" >> $GITHUB_ENV
            
          elif [[ "$BRANCH_NAME" =~ ^pre-release/beta/ ]]; then
            BETA_NUM="${BRANCH_NAME##*/}"
            echo "VERSION_STRATEGY=pre-release" >> $GITHUB_ENV
            echo "ARTIFACT_SUFFIX=beta-$BETA_NUM" >> $GITHUB_ENV
            echo "VERSION_CMD=beta $BETA_NUM" >> $GITHUB_ENV
            
          elif [[ "$BRANCH_NAME" =~ ^pre-release/rc/ ]]; then
            RC_NUM="${BRANCH_NAME##*/}"
            echo "VERSION_STRATEGY=pre-release" >> $GITHUB_ENV
            echo "ARTIFACT_SUFFIX=rc-$RC_NUM" >> $GITHUB_ENV
            echo "VERSION_CMD=rc $RC_NUM" >> $GITHUB_ENV
            
          elif [[ "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            HOTFIX_NUM=$(echo "$BRANCH_NAME" | grep -o '[0-9]*$' || echo "1")
            echo "VERSION_STRATEGY=hotfix" >> $GITHUB_ENV
            echo "ARTIFACT_SUFFIX=hotfix-$HOTFIX_NUM" >> $GITHUB_ENV
            echo "VERSION_CMD=patch && hotfix $HOTFIX_NUM" >> $GITHUB_ENV
            
          else
            echo "VERSION_STRATEGY=keep" >> $GITHUB_ENV
            echo "ARTIFACT_SUFFIX=feature" >> $GITHUB_ENV
            echo "VERSION_CMD=" >> $GITHUB_ENV
          fi
          
          echo "COMMIT_HASH=${{ github.sha }}" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=${{ github.actor }}" >> $GITHUB_ENV
          
          echo "ğŸ¯ Version strategy: $VERSION_STRATEGY"
          echo "ğŸ“¦ Artifact suffix: $ARTIFACT_SUFFIX"

      - name: ğŸ—ï¸ Update version information
        run: |
          if [ -n "$VERSION_CMD" ]; then
            echo "ğŸ”§ Executing: python3 update_version.py $VERSION_CMD"
            
            if [[ "$VERSION_CMD" == *"&&"* ]]; then
              IFS='&&' read -r cmd1 cmd2 <<< "$VERSION_CMD"
              python3 update_version.py $(echo $cmd1 | xargs)
              python3 update_version.py $(echo $cmd2 | xargs)
            else
              python3 update_version.py $VERSION_CMD
            fi
          fi
          
          python3 update_version.py build
          
          # Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ - Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚
          echo "ğŸ“ Commit info: $COMMIT_HASH by $COMMIT_AUTHOR"
          
          echo "ğŸ“Š Final version information:"
          python3 update_version.py info

      - name: ğŸ—ï¸ Compile all plugins
        run: |
          mkdir -p compiled
          chmod +x compile.sh
          ./compile.sh

      - name: ğŸ“‹ Create build info file
        run: |
          echo "BUILD_INFO_START"
          echo "ARTIFACT_NAME=amxx-plugins-$ARTIFACT_SUFFIX"
          echo "VERSION=$(python3 update_version.py get-full-version)"
          echo "BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')"
          echo "BRANCH=${GITHUB_REF#refs/heads/}"
          echo "COMMIT=${{ github.sha }}"
          echo "BUILD_INFO_END"
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ°Ğ¹Ğ»
          python3 update_version.py info > build_info.txt

      - name: ğŸ“¦ Upload artifacts with official action
        uses: actions/upload-artifact@v4
        with:
          name: amxx-plugins-${{ env.ARTIFACT_SUFFIX }}
          path: |
            compiled/*.amxx
            compile.log
            scripting/include/version.inc
            build_info.txt
          retention-days: 30

      - name: ğŸ“‹ Create build summary
        run: |
          FULL_VERSION=$(python3 update_version.py get-full-version)
          echo "## ğŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $FULL_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** amxx-plugins-$ARTIFACT_SUFFIX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          python3 update_version.py info >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true