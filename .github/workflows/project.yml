name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed, ready_for_review]
  workflow_dispatch:
    inputs:
      sync_all:
        description: 'Sync all open issues/PRs to project'
        required: false
        default: false
        type: boolean

jobs:
  project_automation:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Get project data
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          USER: NightMira
          PROJECT_NUMBER: 3
        run: |
          echo "## ðŸ—‚ï¸ Project Automation" >> $GITHUB_STEP_SUMMARY
          
          gh api graphql -f query='
            query($user: String!, $number: Int!) {
              user(login: $user) {
                projectV2(number: $number) {
                  id
                  title
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2Field {
                        id
                        name
                      }
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f user="$USER" -F number="$PROJECT_NUMBER" > project_data.json

          echo "PROJECT_ID=$(jq '.data.user.projectV2.id' project_data.json)" >> $GITHUB_ENV
          echo "PROJECT_TITLE=$(jq -r '.data.user.projectV2.title' project_data.json)" >> $GITHUB_ENV
          
          # ÐŸÐ¾Ð»Ñ Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
          STATUS_FIELD_ID=$(jq '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .id' project_data.json)
          if [ "$STATUS_FIELD_ID" != "null" ] && [ -n "$STATUS_FIELD_ID" ]; then
            echo "STATUS_FIELD_ID=$STATUS_FIELD_ID" >> $GITHUB_ENV
            echo "TODO_OPTION_ID=$(jq '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .options[] | select(.name=="Todo") | .id' project_data.json)" >> $GITHUB_ENV
            echo "DONE_OPTION_ID=$(jq '.data.user.projectV2.fields.nodes[] | select(.name== "Status") | .options[] | select(.name=="Done") | .id' project_data.json)" >> $GITHUB_ENV
          fi

          echo "ðŸ“Š Project: $PROJECT_TITLE" >> $GITHUB_STEP_SUMMARY

      - name: âž• Add item to project (new items)
        if: github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            CONTENT_ID="${{ github.event.issue.node_id }}"
            ITEM_TYPE="issue"
            ITEM_NUMBER=${{ github.event.issue.number }}
          else
            CONTENT_ID="${{ github.event.pull_request.node_id }}"
            ITEM_TYPE="pull request" 
            ITEM_NUMBER=${{ github.event.pull_request.number }}
          fi

          echo "ðŸŽ¯ Adding $ITEM_TYPE #$ITEM_NUMBER to project..." >> $GITHUB_STEP_SUMMARY

          item_id=$(gh api graphql -f query='
            mutation($project:ID!, $content:ID!) {
              addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                item {
                  id
                }
              }
            }' -f project="$PROJECT_ID" -f content="$CONTENT_ID" --jq '.data.addProjectV2ItemById.item.id')

          echo ITEM_ID=$item_id >> $GITHUB_ENV
          echo "âœ… Added to project!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”„ Update item status (closed items)
        if: github.event.action == 'closed'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "ðŸ”„ Updating status for closed item..." >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "issues" ]; then
            CONTENT_ID="${{ github.event.issue.node_id }}"
            ITEM_TYPE="issue"
            ITEM_NUMBER=${{ github.event.issue.number }}
          else
            CONTENT_ID="${{ github.event.pull_request.node_id }}"
            ITEM_TYPE="pull request"
            ITEM_NUMBER=${{ github.event.pull_request.number }}
          fi

          # Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐž: Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ñ„Ð»Ð°Ð³Ð¸
          ITEM_ID=$(gh api graphql -f query='
            query($project: ID!, $content: ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                        }
                        ... on PullRequest {
                          id
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="$PROJECT_ID" -f content="$CONTENT_ID" \
            --jq '.data.node.items.nodes[] | select(.content.id == $content) | .id')

          if [ -n "$ITEM_ID" ] && [ -n "$STATUS_FIELD_ID" ] && [ -n "$DONE_OPTION_ID" ]; then
            gh api graphql -f query='
              mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $project
                  itemId: $item
                  fieldId: $field
                  value: {
                    singleSelectOptionId: $value
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$STATUS_FIELD_ID" -f value="$DONE_OPTION_ID" --silent
            
            echo "âœ… Status updated to Done" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Status update skipped (item not in project or status field not found)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“… Set field values for new items
        if: env.ITEM_ID != '' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review')
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "ðŸ”§ Setting field values for new item..." >> $GITHUB_STEP_SUMMARY
          echo "DATE=$(date +"%Y-%m-%d")" >> $GITHUB_ENV
          
          if [ -n "$STATUS_FIELD_ID" ] && [ -n "$TODO_OPTION_ID" ]; then
            gh api graphql -f query='
              mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $project
                  itemId: $item
                  fieldId: $field
                  value: {
                    singleSelectOptionId: $value
                  }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$STATUS_FIELD_ID" -f value="$TODO_OPTION_ID" --silent
            echo "âœ… Status set to Todo" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Manual sync (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_all == 'true'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "### ðŸ” Manual Sync" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Syncing all open items..." >> $GITHUB_STEP_SUMMARY
          
          # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ñ‡ÐµÑ€ÐµÐ· GraphQL API
          add_to_project() {
            local content_id="$1"
            local item_type="$2"
            local number="$3"
            
            item_id=$(gh api graphql -f query='
              mutation($project:ID!, $content:ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                  item {
                    id
                  }
                }
              }' -f project="$PROJECT_ID" -f content="$content_id" --jq '.data.addProjectV2ItemById.item.id' 2>/dev/null)
            
            if [ -n "$item_id" ] && [ "$item_id" != "null" ]; then
              echo "âœ… $item_type #$number added to project" >> $GITHUB_STEP_SUMMARY
              
              # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ "Todo" Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²
              if [ -n "$STATUS_FIELD_ID" ] && [ -n "$TODO_OPTION_ID" ]; then
                gh api graphql -f query='
                  mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $project
                      itemId: $item
                      fieldId: $field
                      value: {
                        singleSelectOptionId: $value
                      }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }' -f project="$PROJECT_ID" -f item="$item_id" -f field="$STATUS_FIELD_ID" -f value="$TODO_OPTION_ID" --silent 2>/dev/null
              fi
            else
              echo "âš ï¸ $item_type #$number already in project or failed" >> $GITHUB_STEP_SUMMARY
            fi
          }
          
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ issues Ñ‡ÐµÑ€ÐµÐ· GraphQL API
          echo "ðŸ” Fetching open issues..." >> $GITHUB_STEP_SUMMARY
          gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                issues(first: 50, states: OPEN) {
                  nodes {
                    number
                    id
                    title
                  }
                }
              }
            }' -f owner="$USER" -f repo="${{ github.event.repository.name }}" > issues.json
          
          jq -c '.data.repository.issues.nodes[]' issues.json | while read -r issue; do
            number=$(echo "$issue" | jq -r '.number')
            id=$(echo "$issue" | jq -r '.id')
            title=$(echo "$issue" | jq -r '.title')
            
            add_to_project "$id" "Issue" "$number"
          done
          
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ PR Ñ‡ÐµÑ€ÐµÐ· GraphQL API
          echo "ðŸ” Fetching open PRs..." >> $GITHUB_STEP_SUMMARY
          gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                pullRequests(first: 50, states: OPEN) {
                  nodes {
                    number
                    id
                    title
                  }
                }
              }
            }' -f owner="$USER" -f repo="${{ github.event.repository.name }}" > prs.json
          
          jq -c '.data.repository.pullRequests.nodes[]' prs.json | while read -r pr; do
            number=$(echo "$pr" | jq -r '.number')
            id=$(echo "$pr" | jq -r '.id')
            title=$(echo "$pr" | jq -r '.title')
            
            add_to_project "$id" "PR" "$number"
          done
          
          echo "âœ… Manual sync completed!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ Final summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Event:** ${{ github.event_name }}.${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** $PROJECT_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **Result:** âœ… Automation completed" >> $GITHUB_STEP_SUMMARY
