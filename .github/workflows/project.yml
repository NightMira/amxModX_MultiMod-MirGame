name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  project-automation:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 Checkout code (with private token)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: 📋 Process project items
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "## 🗂️ Project Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "### 📝 Issue Processing" >> $GITHUB_STEP_SUMMARY
            echo "- **Issue:** #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Title:** ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### 🔀 Pull Request Processing" >> $GITHUB_STEP_SUMMARY
            echo "- **PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎯 Target Project" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** NightMira/Project#3" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: 📋 Add new items to project
        if: github.event_name == 'issues' && github.event.action == 'opened' || github.event_name == 'pull_request' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "🎯 Adding ${{ github.event_name }} to project..."
          
          if [ "${{ github.event_name }}" = "issues" ]; then
            ITEM_URL="https://github.com/NightMira/amxModX_MultiMod-MirGame/issues/${{ github.event.issue.number }}"
            echo "📝 Issue URL: $ITEM_URL"
          else
            ITEM_URL="https://github.com/NightMira/amxModX_MultiMod-MirGame/pull/${{ github.event.pull_request.number }}"
            echo "📝 PR URL: $ITEM_URL"
          fi
          
          # Добавляем в проект организации NightMira
          if gh project item-add 3 --owner NightMira --url "$ITEM_URL"; then
            echo "✅ Added to project successfully!"
            echo "### ✅ Successfully Added to Project" >> $GITHUB_STEP_SUMMARY
            echo "Item was successfully added to the project." >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Failed to add to project."
            echo "### ⚠️ Failed to Add to Project" >> $GITHUB_STEP_SUMMARY
            echo "There was an issue adding the item to the project." >> $GITHUB_STEP_SUMMARY
          fi

      - name: 📋 Final summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Workflow Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Automatically processed by GitHub Actions*" >> $GITHUB_STEP_SUMMARY